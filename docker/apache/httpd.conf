ServerRoot "/usr/local/apache2"
ServerName localhost
Listen 80

LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule headers_module modules/mod_headers.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule mime_module modules/mod_mime.so
LoadModule dir_module modules/mod_dir.so
LoadModule alias_module modules/mod_alias.so
LoadModule env_module modules/mod_env.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule expires_module modules/mod_expires.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule filter_module modules/mod_filter.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
LoadModule reqtimeout_module modules/mod_reqtimeout.so
LoadModule remoteip_module modules/mod_remoteip.so

User daemon
Group daemon

ServerTokens Prod
ServerSignature Off
TraceEnable Off
FileETag None

Timeout 30
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500
LimitRequestBody 20971520

<IfModule mpm_event_module>
    StartServers 2
    MinSpareThreads 25
    MaxSpareThreads 75
    ThreadLimit 64
    ThreadsPerChild 25
    MaxRequestWorkers 150
    MaxConnectionsPerChild 1000
</IfModule>

PidFile /tmp/httpd.pid
ErrorLog /proc/self/fd/2
LogLevel warn
CustomLog /proc/self/fd/1 combined

TypesConfig conf/mime.types
AddType application/x-httpd-php .php

ProxyRequests Off
ProxyTimeout 60
ProxyPreserveHost On

DocumentRoot "/var/www/public"
<Directory />
    AllowOverride None
    Require all denied
</Directory>

<Directory "/var/www/public">
    AllowOverride None
    Options -Indexes +FollowSymLinks
    Require all granted
    DirectoryIndex index.php
</Directory>

Alias /storage/ "/var/www/storage/app/public/"
<Directory "/var/www/storage/app/public">
    AllowOverride None
    Options -Indexes
    Require all granted
</Directory>

Alias /healthz /var/www/public/healthz.txt

RewriteEngine On
RewriteCond %{REQUEST_URI} !^/healthz$
RewriteCond %{REQUEST_URI} !^/storage/
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ /index.php [L]

ProxyPassMatch "^/(.*\.php(/.*)?)$" "fcgi://app:9000/var/www/html/public/$1"

<FilesMatch "^\.">
    Require all denied
</FilesMatch>
<FilesMatch "(^#.*#|\.(bak|conf|dist|ini|log|orig|psd|sh|sql|swp))$">
    Require all denied
</FilesMatch>
<LocationMatch "^/(composer\.(json|lock)|package(-lock)?\.json|artisan|\.env)">
    Require all denied
</LocationMatch>

Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-Content-Type-Options "nosniff"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set X-XSS-Protection "1; mode=block"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
Header always unset X-Powered-By

<IfModule deflate_module>
    AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css application/javascript application/json image/svg+xml
</IfModule>

<IfModule expires_module>
    ExpiresActive On
    ExpiresByType text/css "access plus 30 days"
    ExpiresByType application/javascript "access plus 30 days"
    ExpiresByType image/png "access plus 30 days"
    ExpiresByType image/jpeg "access plus 30 days"
    ExpiresByType image/svg+xml "access plus 30 days"
    ExpiresByType font/woff2 "access plus 30 days"
</IfModule>
